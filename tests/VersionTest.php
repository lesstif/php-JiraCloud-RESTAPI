<?php

namespace JiraCloud\Test;

use JiraCloud\Dumper;
use PHPUnit\Framework\TestCase;
use JiraCloud\JiraException;
use JiraCloud\Issue\Version;
use JiraCloud\Project\ProjectService;
use JiraCloud\Version\VersionService;

class VersionTest extends TestCase
{
    private string $project = 'TEST';

    /**
     * @test
     *
     * @return string
     * @throws \JsonMapper_Exception
     */
    public function create_version() :string
    {
        $versionName = '2.3.4';
        try {
            $projectService = new ProjectService();
            $project = $projectService->get($this->project);

            $versionService = new VersionService();

            $version = new Version();

            $version->setProjectId($project->id)
                    ->setName($versionName)
                    ->setDescription('Generated by script')
                    ->setReleased(false)
                    ->setStartDateAsDateTime(new \DateTime())
                    ->setReleaseDateAsDateTime((new \DateTime())->add(date_interval_create_from_date_string('2 weeks 3 days')))
                ;

            $res = $versionService->create($version);

            $this->assertEquals($res->name, $versionName);

            return $versionName;
        } catch (JiraException $e) {
            $this->fail("Error Occurred! " . $e->getMessage());
        }

    }

    /**
     * @test
     * @depends create_version
     *
     */
    public function update_project_version(string $versionName) : string
    {
        $newVersionName = null;
        try {
            $versionService = new VersionService();
            $projectService = new ProjectService();

            $ver = $projectService->getVersion($this->project, $versionName);

            // change version name
            $newVersionName = $ver->name . ' Updated name';

            $ver->setName($newVersionName)
                ->setDescription($ver->description . ' Updated description')
                ->setReleased(false)
                ->setStartDateAsDateTime(new \DateTime())
                ->setReleaseDateAsDateTime(
                        (new \DateTime())->add(date_interval_create_from_date_string('1 months 3 days'))
                    )
                ;

            $res = $versionService->update($ver);

            $this->assertEquals($res->name, $ver->name);

        } catch (JiraException $e) {
            $this->fail("Error Occurred! " . $e->getMessage());
        }

        return $newVersionName;
    }

    /**
     * @test
     * @depends update_project_version
     */
    public function delete_project_version(string $newVersionName)
    {
        try {
            $versionService = new VersionService();
            $projectService = new ProjectService();

            $ver = $projectService->getVersion($this->project, $newVersionName);

            $res = $versionService->delete($ver);

            $this->assertEquals(true, $res);
        } catch (JiraException $e) {
            $this->fail("Error Occurred! " . $e->getMessage());
        }
    }
}
